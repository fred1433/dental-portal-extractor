<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dental Insurance Verification Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --success: #16a34a;
            --warning: #ea580c;
            --danger: #dc2626;
            --info: #0891b2;
            --light: #f8fafc;
            --gray: #64748b;
            --dark: #1e293b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: var(--dark);
        }

        .hidden {
            display: none !important;
        }

        /* Header */
        .header {
            background: white;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stats {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--gray);
            text-transform: uppercase;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Search Section */
        .search-section {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
        }

        .search-wrapper {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            font-size: 1.125rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: var(--shadow-lg);
        }

        .autocomplete-item {
            padding: 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .autocomplete-item:hover {
            background: var(--light);
        }

        .patient-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .patient-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--gray);
        }

        /* Patient Details */
        .patient-details {
            display: none;
        }

        .patient-details.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Verification Header */
        .verification-header {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
        }

        .patient-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .display-settings-btn {
            height: 40px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0 1rem;
            border: 1px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 999px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .display-settings-btn:hover {
            background: var(--primary);
            color: white;
        }

        .display-panel {
            position: fixed;
            top: 0;
            right: -420px;
            width: 360px;
            height: 100vh;
            background: white;
            box-shadow: -10px 0 25px rgba(15, 23, 42, 0.15);
            padding: 1.5rem;
            transition: right 0.3s ease;
            z-index: 110;
            overflow-y: auto;
        }

        .display-panel.open {
            right: 0;
        }

        .display-panel header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .display-panel h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
        }

        .panel-close-btn {
            border: none;
            background: transparent;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        .panel-section {
            margin-bottom: 1.5rem;
        }

        .panel-section h3 {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray);
            margin-bottom: 0.75rem;
        }

        .panel-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .panel-option:last-child {
            border-bottom: none;
        }

        .panel-option label {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            cursor: pointer;
        }

        .panel-option small {
            color: var(--gray);
            font-size: 0.75rem;
        }

        .panel-input {
            width: 100%;
            padding: 0.65rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }

        .toggle-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .toggle input {
            margin-right: 0.5rem;
        }

        .toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .chip-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .chip {
            padding: 0.4rem 0.75rem;
            border-radius: 999px;
            background: var(--light);
            border: 1px solid var(--border);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .chip.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .panel-footer {
            display: flex;
            justify-content: space-between;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .panel-footer button {
            flex: 1;
            border: 1px solid var(--border);
            padding: 0.75rem;
            border-radius: 0.75rem;
            cursor: pointer;
            font-weight: 600;
            background: var(--light);
            transition: all 0.2s;
        }

        .panel-footer button.primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .panel-footer button:hover {
            filter: brightness(0.95);
        }

        .patient-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        /* Support Chat */
        .chat-launcher {
            position: fixed;
            right: 2rem;
            bottom: 2rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: var(--primary);
            color: white;
            font-weight: 600;
            font-size: 0.825rem;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.3);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            z-index: 220;
        }

        .chat-launcher:hover,
        .chat-launcher:focus-visible {
            transform: translateY(-2px);
            box-shadow: 0 18px 40px rgba(59, 130, 246, 0.4);
            outline: none;
        }

        .chat-panel {
            position: fixed;
            right: 2rem;
            bottom: 2rem;
            width: 320px;
            max-width: calc(100% - 2rem);
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 45px rgba(30, 41, 59, 0.25);
            display: flex;
            flex-direction: column;
            opacity: 0;
            transform: translateY(24px);
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 230;
            height: 520px;
            max-height: calc(100vh - 4rem);
        }

        .chat-panel.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .chat-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
        }

        .chat-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--dark);
        }

        .chat-subtitle {
            font-size: 0.75rem;
            color: var(--gray);
        }

        .chat-close-btn {
            border: none;
            background: var(--light);
            color: var(--gray);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .chat-close-btn:hover,
        .chat-close-btn:focus-visible {
            background: var(--primary);
            color: white;
            outline: none;
        }

        .chat-messages {
            padding: 1rem 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            background: var(--light);
        }

        .chat-message {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .chat-message.from-user {
            align-items: flex-end;
        }

        .chat-bubble {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            background: white;
            color: var(--dark);
            font-size: 0.9rem;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
            max-width: 85%;
        }

        .chat-message.from-user .chat-bubble {
            background: var(--primary);
            color: white;
            box-shadow: 0 6px 18px rgba(37, 99, 235, 0.35);
        }

        .chat-meta {
            font-size: 0.7rem;
            color: var(--gray);
        }

        .chat-input-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.85rem 1.25rem 1.25rem;
            border-top: 1px solid var(--border);
            background: white;
        }

        .chat-input {
            flex: 1;
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 0.65rem 1rem;
            font-size: 0.9rem;
            transition: border-color 0.2s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
        }

        .chat-send-btn {
            border: none;
            background: var(--primary);
            color: white;
            font-weight: 600;
            border-radius: 999px;
            padding: 0.65rem 1.25rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .chat-send-btn:hover,
        .chat-send-btn:focus-visible {
            background: var(--primary-dark);
            outline: none;
        }

        .chat-typing {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .chat-typing span {
            width: 6px;
            height: 6px;
            background: currentColor;
            border-radius: 50%;
            animation: chatBounce 1s infinite ease-in-out;
        }

        .chat-typing span:nth-child(2) {
            animation-delay: 0.15s;
        }

        .chat-typing span:nth-child(3) {
            animation-delay: 0.3s;
        }

        @keyframes chatBounce {
            0%, 80%, 100% { opacity: 0.2; transform: translateY(0); }
            40% { opacity: 1; transform: translateY(-3px); }
        }

        .patient-subtitle {
            color: var(--gray);
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            font-size: 0.9rem;
        }

        .patient-subtitle .subtitle-item {
            display: inline-flex;
            align-items: baseline;
            gap: 0.5rem;
        }

        .patient-subtitle .subtitle-label {
            font-weight: 600;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 0.75rem;
        }

        .patient-subtitle .subtitle-label::after {
            content: ":";
            margin-left: 0.35rem;
        }

        .patient-subtitle .subtitle-value {
            font-size: 0.9rem;
            color: var(--dark);
            font-weight: 500;
        }

        .action-buttons {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-outline {
            background: white;
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-outline:hover {
            background: var(--light);
        }

        /* Grid Layout */
        .details-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 1.5rem;
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .card-header {
            background: var(--light);
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-body {
            padding: 1.25rem;
        }

        /* Financial Cards */
        .financial-item {
            padding: 1rem;
            background: var(--light);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .financial-item:last-child {
            margin-bottom: 0;
        }

        .financial-label {
            font-size: 0.875rem;
            color: var(--gray);
            margin-bottom: 0.5rem;
        }

        .financial-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .financial-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: var(--gray);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }

        /* Info Items */
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--gray);
            font-size: 0.875rem;
        }

        .info-value {
            font-weight: 500;
            text-align: right;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            font-weight: 500;
            color: var(--gray);
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
        }

        .tab:hover {
            color: var(--dark);
        }

        .tab.active {
            color: var(--primary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Procedures Table */
        .procedures-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .filter-select {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .procedures-table {
            width: 100%;
            border-collapse: collapse;
        }

        .procedures-table th {
            background: var(--light);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .procedures-table td {
            padding: 1rem 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .procedures-table tr:hover {
            background: var(--light);
        }

        .procedures-table.hide-col-code th.col-code,
        .procedures-table.hide-col-code td.col-code,
        .procedures-table.hide-col-description th.col-description,
        .procedures-table.hide-col-description td.col-description,
        .procedures-table.hide-col-category th.col-category,
        .procedures-table.hide-col-category td.col-category,
        .procedures-table.hide-col-planclass th.col-planclass,
        .procedures-table.hide-col-planclass td.col-planclass,
        .procedures-table.hide-col-innetwork th.col-innetwork,
        .procedures-table.hide-col-innetwork td.col-innetwork,
        .procedures-table.hide-col-outnetwork th.col-outnetwork,
        .procedures-table.hide-col-outnetwork td.col-outnetwork,
        .procedures-table.hide-col-frequency th.col-frequency,
        .procedures-table.hide-col-frequency td.col-frequency {
            display: none;
        }

        .procedures-table.hide-frequency-sharing .frequency-sharing,
        .procedures-table.hide-frequency-age .frequency-age {
            display: none;
        }

        .procedure-code {
            font-weight: 600;
            color: var(--primary);
        }

        .category-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--light);
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .category-badge.diagnostic { background: #dbeafe; color: #1e40af; }
        .category-badge.preventive { background: #dcfce7; color: #16a34a; }
        .category-badge.restorative { background: #fef3c7; color: #d97706; }
        .category-badge.endodontics { background: #fce7f3; color: #db2777; }
        .category-badge.periodontics { background: #e0e7ff; color: #4f46e5; }
        .category-badge.prosthodontics { background: #f3e8ff; color: #9333ea; }
        .category-badge.oral-surgery { background: #fee2e2; color: #dc2626; }
        .category-badge.orthodontics { background: #cffafe; color: #0891b2; }

        .coverage-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .coverage-badge.high { background: #dcfce7; color: #16a34a; }
        .coverage-badge.medium { background: #fef3c7; color: #d97706; }
        .coverage-badge.low { background: #fee2e2; color: #dc2626; }

        .frequency-text {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: var(--gray);
        }

        .frequency-sharing {
            color: var(--info);
            font-size: 0.7rem;
        }

        .frequency-age {
            color: var(--warning);
            font-size: 0.7rem;
        }

        .plan-class-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--light);
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray);
        }

        .favorite-procedure {
            background: rgba(59, 130, 246, 0.08);
        }

        .favorite-procedure .procedure-code::before {
            content: '★';
            color: #f59e0b;
            margin-right: 0.35rem;
        }

        .deductible-tag {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            background: var(--info);
            color: white;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }

        /* Claims History */
        .claim-item {
            padding: 1rem;
            background: var(--light);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .claim-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
        }

        .claim-id {
            font-weight: 600;
            color: var(--primary);
        }

        .claim-status {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .claim-status.paid { background: #dcfce7; color: #16a34a; }
        .claim-status.pending { background: #fef3c7; color: #d97706; }
        .claim-status.denied { background: #fee2e2; color: #dc2626; }

        .claim-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            font-size: 0.875rem;
        }

        /* Limitations */
        .limitation-item {
            padding: 1rem;
            background: #fef3c7;
            border-left: 4px solid var(--warning);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .limitation-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--warning);
        }

        .limitation-text {
            font-size: 0.875rem;
            line-height: 1.5;
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
        }

        .spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .details-grid {
                grid-template-columns: 1fr;
            }

            .sidebar {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }
        }

        @media (max-width: 640px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .stats {
                width: 100%;
                justify-content: space-around;
            }

            .sidebar {
                grid-template-columns: 1fr;
            }

            .procedures-table {
                font-size: 0.875rem;
            }

            .procedures-table th,
            .procedures-table td {
                padding: 0.5rem;
            }

            .chat-launcher {
                right: 1rem;
                bottom: 1rem;
            }

            .chat-panel {
                right: 1rem;
                bottom: 1rem;
                width: calc(100% - 2rem);
                height: calc(100vh - 2rem);
                max-height: calc(100vh - 2rem);
            }

            .chat-messages {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <span>🦷</span>
                <span>Park Place Pediatric Dentistry and Orthodontics</span>
            </div>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="stat-patients">0</div>
                    <div class="stat-label">Patients</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Search Section -->
        <div class="search-section">
            <div class="search-wrapper">
                <span class="search-icon">🔍</span>
                <input type="text"
                       class="search-input"
                       id="searchInput"
                       placeholder="Search by patient name or member ID...">
                <div class="autocomplete-dropdown" id="autocompleteDropdown" style="display: none;"></div>
            </div>
        </div>

        <!-- Patient Details -->
        <div class="patient-details" id="patientDetails">
            <!-- Verification Header -->
            <div class="verification-header">
                <div class="patient-header">
                    <div>
                        <h1 class="patient-title" id="patientName"></h1>
                        <div class="patient-subtitle">
                            <span class="subtitle-item"><span class="subtitle-label">DOB</span><span class="subtitle-value" id="patientDOB"></span></span>
                            <span class="subtitle-item"><span class="subtitle-label">Member ID</span><span class="subtitle-value" id="patientMemberID"></span></span>
                            <span class="subtitle-item"><span class="subtitle-label">Plan</span><span class="subtitle-value" id="patientPlan"></span></span>
                            <span class="subtitle-item"><span class="subtitle-label">Group</span><span class="subtitle-value" id="patientGroup"></span></span>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="display-settings-btn" id="displaySettingsToggle">⚙️ Display Settings</button>
                    </div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="details-grid">
                <!-- Sidebar -->
                <div class="sidebar">
                    <!-- Financial Summary Card -->
                    <div class="card" id="financialCard">
                        <div class="card-header">
                            💰 Financial Summary
                        </div>
                        <div class="card-body">
                            <div class="financial-item">
                                <div class="financial-label">Annual Maximum</div>
                                <div class="financial-value" id="annualMaxRemaining">$0</div>
                                <div class="financial-details">
                                    <span>Used: $<span id="annualMaxUsed">0</span></span>
                                    <span>Total: $<span id="annualMaxTotal">0</span></span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="annualMaxProgress" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="financial-item">
                                <div class="financial-label">Individual Deductible</div>
                                <div class="financial-value" id="deductibleRemaining">$0</div>
                                <div class="financial-details">
                                    <span>Met: $<span id="deductibleMet">0</span></span>
                                    <span>Total: $<span id="deductibleTotal">0</span></span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="deductibleProgress" style="width: 0%"></div>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.5rem;" id="deductibleAppliesTo">
                                    Applies to: Loading...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Plan Details Card -->
                    <div class="card" id="planCard">
                        <div class="card-header">
                            📋 Plan Details
                        </div>
                        <div class="card-body">
                            <div class="info-item">
                                <span class="info-label">Plan Type</span>
                                <span class="info-value" id="planType">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Group Number</span>
                                <span class="info-value" id="groupNumber">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Division</span>
                                <span class="info-value" id="divisionNumber">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Payer ID</span>
                                <span class="info-value" id="payerId">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Effective Date</span>
                                <span class="info-value" id="effectiveDate">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Policy Type</span>
                                <span class="info-value" id="policyType">Calendar</span>
                            </div>
                            <div class="info-item" style="cursor: help;" title="Click for details">
                                <span class="info-label">COB</span>
                                <span class="info-value" id="cob" onclick="showCobDetails()">No</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">AOB</span>
                                <span class="info-value" id="aob">Yes</span>
                            </div>
                            <div class="info-item" style="border-top: 1px solid var(--border); padding-top: 1rem; margin-top: 0.5rem;">
                                <span class="info-label">Claims Address</span>
                                <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;" id="claimsAddress">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Limitations Card -->
                    <div class="card" id="limitationsCard">
                        <div class="card-header">
                            ⚠️ Key Limitations
                        </div>
                        <div class="card-body" id="limitationsContent">
                            <div class="limitation-item">
                                <div class="limitation-title">Waiting Periods</div>
                                <div class="limitation-text" id="waitingPeriods">None</div>
                            </div>
                            <div class="limitation-item">
                                <div class="limitation-title">Missing Tooth Clause</div>
                                <div class="limitation-text" id="missingTooth">Not applicable</div>
                            </div>
                            <div class="limitation-item" id="orthodonticsLimitation" style="display: none;">
                                <div class="limitation-title">Orthodontics</div>
                                <div class="limitation-text" id="orthodonticsDetails">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="main-content">
                    <!-- Tabs -->
                    <div class="card">
                        <div class="tabs">
                            <button class="tab active" id="tab-btn-procedures" onclick="switchTab('procedures')">Procedures</button>
                            <button class="tab" id="tab-btn-history" onclick="switchTab('history')">History</button>
                            <button class="tab" id="tab-btn-claims" onclick="switchTab('claims')">Claims</button>
                            <button class="tab" id="tab-btn-notes" onclick="switchTab('notes')">Notes</button>
                        </div>

                        <!-- Procedures Tab -->
                        <div class="tab-content active" id="tab-procedures">
                            <div class="card-body">
                                <div class="procedures-filters">
                                    <div class="filter-group">
                                        <label>Category:</label>
                                        <select class="filter-select" id="categoryFilter" onchange="filterProcedures()">
                                            <option value="">All Categories</option>
                                            <option value="Diagnostic">Diagnostic</option>
                                            <option value="Preventive">Preventive</option>
                                            <option value="Restorative">Restorative</option>
                                            <option value="Endodontics">Endodontics</option>
                                            <option value="Periodontics">Periodontics</option>
                                            <option value="Prosthodontics">Prosthodontics</option>
                                            <option value="Oral Surgery">Oral Surgery</option>
                                            <option value="Orthodontics">Orthodontics</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <label>Class:</label>
                                        <select class="filter-select" id="classFilter" onchange="filterProcedures()">
                                            <option value="">All Classes</option>
                                            <option value="Diagnostic-Preventive">Diagnostic-Preventive</option>
                                            <option value="Basic">Basic</option>
                                            <option value="Major">Major</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <input type="text"
                                               class="filter-select"
                                               id="procedureSearch"
                                               placeholder="Search procedures..."
                                               onkeyup="filterProcedures()">
                                    </div>
                                </div>

                                <table class="procedures-table" id="proceduresTable">
                                    <thead>
                                        <tr>
                                            <th class="col-code">Code</th>
                                            <th class="col-description">Procedure</th>
                                            <th class="col-category">Category</th>
                                            <th class="col-planclass">Plan Class</th>
                                            <th class="col-innetwork">In-Network</th>
                                            <th class="col-outnetwork">Out-Network</th>
                                            <th class="col-frequency">Frequency/Limits</th>
                                        </tr>
                                    </thead>
                                    <tbody id="proceduresTableBody">
                                        <!-- Procedures will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- History Tab -->
                        <div class="tab-content" id="tab-history">
                            <div class="card-body">
                                <table class="procedures-table">
                                    <thead>
                                        <tr>
                                            <th>Code</th>
                                            <th>Procedure</th>
                                            <th>First Service</th>
                                            <th>Last Service</th>
                                            <th>Count</th>
                                        </tr>
                                    </thead>
                                    <tbody id="historyTableBody">
                                        <!-- History will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Claims Tab -->
                        <div class="tab-content" id="tab-claims">
                            <div class="card-body" id="claimsContent">
                                <!-- Claims will be inserted here -->
                            </div>
                        </div>

                        <!-- Notes Tab -->
                        <div class="tab-content" id="tab-notes">
                            <div class="card-body">
                                <textarea style="width: 100%; height: 400px; padding: 1rem; border: 1px solid var(--border); border-radius: 0.5rem;"
                                          placeholder="Add verification notes here..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="display-panel" id="displaySettingsPanel">
        <header>
            <h2>Display Settings</h2>
            <button class="panel-close-btn" id="displaySettingsClose" aria-label="Close">&times;</button>
        </header>
        <div id="displaySettingsContent"></div>
        <div class="panel-footer">
            <button id="resetDisplaySettings">Reset</button>
            <button class="primary" id="saveDisplaySettings">Save</button>
        </div>
    </div>

    <button
        class="chat-launcher"
        id="chatLauncher"
        type="button"
        aria-label="Open support chat"
        aria-haspopup="dialog"
        aria-expanded="false"
        aria-controls="chatPanel">
        Chat
    </button>

    <section
        class="chat-panel"
        id="chatPanel"
        role="dialog"
        aria-modal="false"
        aria-labelledby="chatTitle">
        <header class="chat-header">
            <div>
                <div class="chat-title" id="chatTitle">Virtual Assistant</div>
                <div class="chat-subtitle" id="chatSubtitle">Smart coverage guide</div>
            </div>
            <button class="chat-close-btn" id="chatCloseButton" type="button" aria-label="Close chat">&times;</button>
        </header>
        <div class="chat-messages" id="chatMessages" aria-live="polite"></div>
        <form class="chat-input-container" id="chatForm">
            <input
                type="text"
                class="chat-input"
                id="chatInput"
                name="chatInput"
                placeholder="Ask anything about benefits..."
                autocomplete="off"
                aria-label="Type a message for the assistant">
            <button class="chat-send-btn" type="submit">Send</button>
        </form>
    </section>

    <script>
        // Global variables
        let currentPatient = null;
        let allProcedures = [];
        let visibleProcedures = [];
        let chatPanelIsOpen = false;
        let chatHasShownWelcome = false;
        let chatResponseTimeout = null;

        const deepClone = value => {
            try {
                if (typeof structuredClone === 'function') {
                    return structuredClone(value);
                }
            } catch (_) {
                // Ignore and fall back to JSON clone
            }
            return JSON.parse(JSON.stringify(value));
        };

        const defaultDisplaySettings = {
            sections: {
                financial: true,
                plan: true,
                limitations: true,
                procedures: true,
                history: true,
                claims: true,
                notes: true
            },
            columns: {
                code: true,
                description: true,
                category: true,
                planClass: true,
                inNetwork: true,
                outNetwork: true,
                frequency: true,
                sharing: true,
                ageLimit: true
            },
            topCount: 'all',
            favorites: [],
            showOnlyFavorites: false,
            activePreset: 'default'
        };

        const DISPLAY_PRESETS = {
            default: {
                label: 'Full',
                description: 'Shows every section',
                overrides: {}
            },
            essential: {
                label: 'Essential',
                description: 'Front-desk view: summary plus top 10 procedures',
                overrides: {
                    sections: {
                        limitations: false,
                        history: false,
                        claims: false,
                        notes: false
                    },
                    columns: {
                        outNetwork: false,
                        sharing: false,
                        ageLimit: false
                    },
                    topCount: '10'
                }
            },
            ortho: {
                label: 'Orthodontics',
                description: 'Highlights limitations and orthodontic coverage',
                overrides: {
                    sections: {
                        limitations: true,
                        procedures: true,
                        history: true,
                        claims: false,
                        notes: false
                    },
                    columns: {
                        inNetwork: true,
                        outNetwork: false,
                        sharing: true,
                        ageLimit: true
                    },
                    favorites: ['D8080', 'D8090', 'D8660', 'D8670'],
                    showOnlyFavorites: false,
                    topCount: '15'
                }
            }
        };

        let displaySettings = loadDisplaySettings();

        const SECTION_ELEMENT_IDS = {
            financial: 'financialCard',
            plan: 'planCard',
            limitations: 'limitationsCard',
            procedures: 'tab-procedures',
            history: 'tab-history',
            claims: 'tab-claims',
            notes: 'tab-notes'
        };

        const TAB_BUTTON_IDS = {
            procedures: 'tab-btn-procedures',
            history: 'tab-btn-history',
            claims: 'tab-btn-claims',
            notes: 'tab-btn-notes'
        };

        function setupDisplaySettingsControls() {
            const toggleButton = document.getElementById('displaySettingsToggle');
            const panel = document.getElementById('displaySettingsPanel');
            const closeButton = document.getElementById('displaySettingsClose');
            const resetButton = document.getElementById('resetDisplaySettings');
            const saveButton = document.getElementById('saveDisplaySettings');

            if (!panel) return;

            const openPanel = () => panel.classList.add('open');
            const closePanel = () => panel.classList.remove('open');

            if (toggleButton) {
                toggleButton.addEventListener('click', () => {
                    renderDisplaySettingsUI();
                    openPanel();
                });
            }

            if (closeButton) {
                closeButton.addEventListener('click', closePanel);
            }

            if (saveButton) {
                saveButton.addEventListener('click', () => {
                    saveDisplaySettings();
                    closePanel();
                });
            }

            if (resetButton) {
                resetButton.addEventListener('click', () => {
                    resetDisplaySettings();
                    renderDisplaySettingsUI();
                });
            }

            document.addEventListener('keydown', event => {
                if (event.key === 'Escape') {
                    closePanel();
                }
            });

            document.addEventListener('click', event => {
                if (!panel.contains(event.target) && event.target !== toggleButton && panel.classList.contains('open')) {
                    closePanel();
                }
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            setupSearch();
            setupDisplaySettingsControls();
            applyDisplaySettings();
            renderDisplaySettingsUI();
            setupChat();
        });

        function loadDisplaySettings() {
            try {
                const stored = localStorage.getItem('displayPreferences');
                if (!stored) return deepClone(defaultDisplaySettings);
                const parsed = JSON.parse(stored);
                return mergeSettings(defaultDisplaySettings, parsed);
            } catch (error) {
                console.warn('Unable to load display settings, using defaults', error);
                return deepClone(defaultDisplaySettings);
            }
        }

        function saveDisplaySettings() {
            try {
                localStorage.setItem('displayPreferences', JSON.stringify(displaySettings));
            } catch (error) {
                console.warn('Unable to persist display settings', error);
            }
        }

        function mergeSettings(defaults, overrides) {
            const result = deepClone(defaults);
            if (!overrides) return result;

            for (const key of Object.keys(overrides)) {
                if (typeof overrides[key] === 'object' && overrides[key] !== null && !Array.isArray(overrides[key])) {
                    result[key] = {
                        ...defaults[key],
                        ...overrides[key]
                    };
                } else {
                    result[key] = overrides[key];
                }
            }

            return result;
        }

        function resetDisplaySettings() {
            displaySettings = deepClone(defaultDisplaySettings);
            displaySettings.activePreset = 'default';
            saveDisplaySettings();
            applyDisplaySettings();
            renderDisplaySettingsUI();
        }

        function applyDisplaySettings() {
            applySectionVisibility();
            applyProcedureColumnVisibility();
            applyProcedureFilters();
        }

        function applySectionVisibility() {
            Object.entries(SECTION_ELEMENT_IDS).forEach(([key, elementId]) => {
                const element = document.getElementById(elementId);
                if (!element) return;
                const isVisible = Boolean(displaySettings.sections[key]);
                element.classList.toggle('hidden', !isVisible);

                if (TAB_BUTTON_IDS[key]) {
                    const button = document.getElementById(TAB_BUTTON_IDS[key]);
                    if (button) {
                        button.classList.toggle('hidden', !isVisible);
                    }
                }
            });

            const activeButton = document.querySelector('.tabs .tab.active');
            if (activeButton && activeButton.classList.contains('hidden')) {
                const fallbackKey = Object.keys(TAB_BUTTON_IDS).find(key => displaySettings.sections[key]);
                if (fallbackKey) {
                    const buttonId = TAB_BUTTON_IDS[fallbackKey];
                    const contentId = SECTION_ELEMENT_IDS[fallbackKey];
                    const fallbackButton = document.getElementById(buttonId);
                    const fallbackContent = document.getElementById(contentId);
                    if (fallbackButton && fallbackContent) {
                        document.querySelectorAll('.tabs .tab').forEach(tab => tab.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                        fallbackButton.classList.add('active');
                        fallbackContent.classList.add('active');
                    }
                }
            }
        }

        function applyProcedureColumnVisibility() {
            const table = document.getElementById('proceduresTable');
            if (!table) return;

            const columnMap = {
                code: 'col-code',
                description: 'col-description',
                category: 'col-category',
                planClass: 'col-planclass',
                inNetwork: 'col-innetwork',
                outNetwork: 'col-outnetwork',
                frequency: 'col-frequency'
            };

            Object.entries(columnMap).forEach(([settingKey, className]) => {
                table.classList.toggle(`hide-${className}`, !displaySettings.columns[settingKey]);
            });

            table.classList.toggle('hide-frequency-sharing', !displaySettings.columns.sharing);
            table.classList.toggle('hide-frequency-age', !displaySettings.columns.ageLimit);
        }

        function applyProcedureFilters() {
            if (!allProcedures || allProcedures.length === 0) return;
            filterProcedures();
        }

        function renderDisplaySettingsUI() {
            const content = document.getElementById('displaySettingsContent');
            if (!content) return;

            const sectionLabels = {
                financial: 'Financial Summary',
                plan: 'Plan Details',
                limitations: 'Limitations',
                procedures: 'Procedures',
                history: 'History',
                claims: 'Claims',
                notes: 'Internal Notes'
            };

            const columnLabels = {
                code: 'Code',
                description: 'Description',
                category: 'CDT category',
                planClass: 'Plan class',
                inNetwork: 'In-network rate',
                outNetwork: 'Out-of-network rate',
                frequency: 'Frequency & limits',
                sharing: 'Frequency sharing',
                ageLimit: 'Age limits'
            };

            const presetButtons = Object.entries(DISPLAY_PRESETS).map(([key, preset]) => {
                const isActive = displaySettings.activePreset === key;
                return `<span class="chip ${isActive ? 'active' : ''}" data-type="preset" data-value="${key}" title="${preset.description}">${preset.label}</span>`;
            }).join('');

            const sectionOptions = Object.entries(displaySettings.sections).map(([key, value]) => `
                <div class="panel-option">
                    <label for="section-${key}">
                        ${sectionLabels[key] || key}
                        <small>Show this section</small>
                    </label>
                    <input type="checkbox" id="section-${key}" data-type="section" data-key="${key}" ${value ? 'checked' : ''}>
                </div>
            `).join('');

            const columnOptions = Object.entries(displaySettings.columns).map(([key, value]) => `
                <div class="panel-option">
                    <label for="column-${key}">${columnLabels[key] || key}</label>
                    <input type="checkbox" id="column-${key}" data-type="column" data-key="${key}" ${value ? 'checked' : ''}>
                </div>
            `).join('');

            const topOptions = ['10', '15', '25', 'all'].map(option => {
                const label = option === 'all' ? 'Show all' : `Top ${option}`;
                const activeClass = displaySettings.topCount === option ? 'active' : '';
                return `<span class="chip ${activeClass}" data-type="top" data-value="${option}">${label}</span>`;
            }).join('');

            const favoritesValue = (displaySettings.favorites || []).join(', ');

            content.innerHTML = `
                <div class="panel-section">
                    <h3>Presets</h3>
                    <div class="chip-group" id="presetChips">
                        ${presetButtons}
                    </div>
                </div>
                <div class="panel-section">
                    <h3>Sections</h3>
                    ${sectionOptions}
                </div>
                <div class="panel-section">
                    <h3>Procedure columns</h3>
                    ${columnOptions}
                </div>
                <div class="panel-section">
                    <h3>Procedures</h3>
                    <div class="panel-option">
                        <label for="favoritesInput">
                            Favorites (comma-separated CDT codes)
                            <small>Example: D0120, D1351</small>
                        </label>
                    </div>
                    <input type="text" id="favoritesInput" class="panel-input" value="${favoritesValue}" placeholder="Favorite CDT codes">
                    <div class="toggle-row">
                        <label class="toggle">
                            <input type="checkbox" id="favoritesOnlyToggle" ${displaySettings.showOnlyFavorites ? 'checked' : ''}>
                            <span>Show favorites only</span>
                        </label>
                    </div>
                    <div class="chip-group" id="topCountChips">
                        ${topOptions}
                    </div>
                </div>
            `;

            attachDisplaySettingsEvents();
        }

        function attachDisplaySettingsEvents() {
            const content = document.getElementById('displaySettingsContent');
            if (!content) return;

            content.querySelectorAll('input[type="checkbox"]').forEach(input => {
                input.addEventListener('change', handleDisplaySettingChange);
            });

            const favoritesInput = document.getElementById('favoritesInput');
            if (favoritesInput) {
                favoritesInput.addEventListener('keydown', event => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        favoritesInput.blur();
                    }
                });

                favoritesInput.addEventListener('blur', () => {
                    const codes = favoritesInput.value
                        .split(',')
                        .map(code => code.trim().toUpperCase())
                        .filter(code => code);
                    displaySettings.favorites = Array.from(new Set(codes));
                    displaySettings.activePreset = 'custom';
                    saveDisplaySettings();
                    applyDisplaySettings();
                });
            }

            const favoritesToggle = document.getElementById('favoritesOnlyToggle');
            if (favoritesToggle) {
                favoritesToggle.addEventListener('change', event => {
                    displaySettings.showOnlyFavorites = event.target.checked;
                    displaySettings.activePreset = 'custom';
                    saveDisplaySettings();
                    applyDisplaySettings();
                });
            }

            const presetChips = content.querySelectorAll('#presetChips .chip');
            presetChips.forEach(chip => {
                chip.addEventListener('click', () => {
                    applyPreset(chip.dataset.value);
                });
            });

            const chips = content.querySelectorAll('#topCountChips .chip');
            chips.forEach(chip => {
                chip.addEventListener('click', () => {
                    displaySettings.topCount = chip.dataset.value;
                    displaySettings.activePreset = 'custom';
                    saveDisplaySettings();
                    applyDisplaySettings();
                    renderDisplaySettingsUI();
                });
            });
        }

        function handleDisplaySettingChange(event) {
            const { type, key } = event.target.dataset;
            const isChecked = event.target.checked;

            if (type === 'section') {
                displaySettings.sections[key] = isChecked;
            } else if (type === 'column') {
                displaySettings.columns[key] = isChecked;
            }

            displaySettings.activePreset = 'custom';
            saveDisplaySettings();
            applyDisplaySettings();
        }

        function applyPreset(presetKey) {
            const preset = DISPLAY_PRESETS[presetKey];
            if (!preset) return;

            const overrides = preset.overrides ? deepClone(preset.overrides) : {};
            displaySettings = mergeSettings(defaultDisplaySettings, overrides);
            displaySettings.activePreset = presetKey;
            saveDisplaySettings();
            applyDisplaySettings();
            renderDisplaySettingsUI();
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch('http://localhost:5001/api/stats');
                const stats = await response.json();

                document.getElementById('stat-patients').textContent = stats.totalPatients || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Setup search functionality
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            const dropdown = document.getElementById('autocompleteDropdown');
            let searchTimeout;

            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();

                if (query.length < 2) {
                    dropdown.style.display = 'none';
                    return;
                }

                searchTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`http://localhost:5001/api/search?q=${encodeURIComponent(query)}`);
                        const data = await response.json();

                        if (data.results && data.results.length > 0) {
                            showSearchResults(data.results);
                        } else {
                            dropdown.style.display = 'none';
                        }
                    } catch (error) {
                        console.error('Search error:', error);
                    }
                }, 300);
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        // Show search results
        function showSearchResults(results) {
            const dropdown = document.getElementById('autocompleteDropdown');
            dropdown.innerHTML = '';

            results.forEach(patient => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.innerHTML = `
                    <div class="patient-name">${patient.firstName} ${patient.lastName}</div>
                    <div class="patient-meta">
                        <span>DOB: ${patient.dateOfBirth}</span>
                        <span>ID: ${patient.memberId}</span>
                        <span>Plan: ${patient.planName}</span>
                        <span style="display:none;">${patient.hasFullData ? '✓ Full Data' : '○ Basic'}</span>
                    </div>
                `;
                item.onclick = () => loadPatient(patient.id);
                dropdown.appendChild(item);
            });

            dropdown.style.display = 'block';
        }

        // Load patient details
        async function loadPatient(patientId) {
            try {
                // Hide dropdown and clear search
                document.getElementById('autocompleteDropdown').style.display = 'none';
                document.getElementById('searchInput').value = '';

                // Show loading state
                document.getElementById('patientDetails').classList.add('active');

                const response = await fetch(`http://localhost:5001/api/patient/${patientId}`);
                const patient = await response.json();

                if (!response.ok) {
                    throw new Error(patient.error || 'Failed to load patient');
                }

                currentPatient = patient;
                displayPatientDetails(patient);
            } catch (error) {
                console.error('Error loading patient:', error);
                alert('Error loading patient details: ' + error.message);
            }
        }

        // Display patient details
        function displayPatientDetails(patient) {
            // Update header
            document.getElementById('patientName').textContent =
                `${patient.basicInfo.firstName} ${patient.basicInfo.lastName}`;
            document.getElementById('patientDOB').textContent = patient.basicInfo.dateOfBirth;
            document.getElementById('patientMemberID').textContent = patient.basicInfo.memberId;
            document.getElementById('patientPlan').textContent = patient.planInfo.planName;
            document.getElementById('patientGroup').textContent = patient.planInfo.groupName;

            if (patient.hasFullData && patient.fullData) {
                const data = patient.fullData;

                // Update financial summary
                updateFinancialSummary(data.financial);

                // Update plan details
                updatePlanDetails(data.plan);

                // Update limitations
                updateLimitations(data.limitations);

                // Update procedures
                updateProcedures(data.procedures, { updateSource: true });

                // Update history
                updateHistory(data.history);

                // Update claims
                updateClaims(data.claims);

                applyDisplaySettings();
                renderDisplaySettingsUI();
            }
        }

        // Update financial summary
        function updateFinancialSummary(financial) {
            // Annual Maximum
            const annualMax = financial.maximums['Annual Individual'] ||
                             financial.maximums['Calendar Individual Maximum'] ||
                             Object.values(financial.maximums)[0] || {};

            document.getElementById('annualMaxRemaining').textContent =
                `$${annualMax.remaining || 0}`;
            document.getElementById('annualMaxUsed').textContent = annualMax.used || 0;
            document.getElementById('annualMaxTotal').textContent = annualMax.total || 0;

            const maxPercent = annualMax.total ?
                (annualMax.used / annualMax.total * 100).toFixed(0) : 0;
            document.getElementById('annualMaxProgress').style.width = `${maxPercent}%`;

            // Deductible
            const deductible = financial.deductibles['Individual'] ||
                              financial.deductibles['Family'] ||
                              Object.values(financial.deductibles)[0] || {};

            document.getElementById('deductibleRemaining').textContent =
                `$${deductible.remaining || 0}`;
            document.getElementById('deductibleMet').textContent = deductible.used || 0;
            document.getElementById('deductibleTotal').textContent = deductible.total || 0;

            const dedPercent = deductible.total ?
                (deductible.used / deductible.total * 100).toFixed(0) : 0;
            document.getElementById('deductibleProgress').style.width = `${dedPercent}%`;

            // Deductible applies to
            if (deductible.appliesTo && deductible.appliesTo.length > 0) {
                const appliesTo = deductible.appliesTo.slice(0, 3).join(', ');
                const more = deductible.appliesTo.length > 3 ? ` +${deductible.appliesTo.length - 3} more` : '';
                document.getElementById('deductibleAppliesTo').textContent =
                    `Applies to: ${appliesTo}${more}`;
            }
        }

        // Update plan details
        function updatePlanDetails(plan) {
            document.getElementById('planType').textContent = plan.product || 'PPO';
            document.getElementById('groupNumber').textContent = plan.groupNumber || '-';
            document.getElementById('divisionNumber').textContent = plan.divisionNumber || '-';
            document.getElementById('payerId').textContent = plan.payerIdEDI || plan.payerId || '-';
            document.getElementById('effectiveDate').textContent =
                plan.effectiveDate || '-';
            document.getElementById('policyType').textContent = plan.policyType || 'Calendar';

            // COB with hover for full text
            const cobElement = document.getElementById('cob');
            if (plan.coordinationOfBenefits) {
                cobElement.textContent = 'Yes';
                cobElement.style.textDecoration = 'underline';
                cobElement.title = typeof plan.coordinationOfBenefits === 'string' ?
                    plan.coordinationOfBenefits : 'Standard COB applies';
                window.cobDetails = plan.coordinationOfBenefits;
            } else {
                cobElement.textContent = 'No';
            }

            document.getElementById('aob').textContent =
                plan.assignmentOfBenefits ? 'Yes' : 'No';

            // Claims address
            if (plan.claimsMailingAddress) {
                const addr = plan.claimsMailingAddress;
                document.getElementById('claimsAddress').innerHTML = `
                    ${addr.company || 'Delta Dental'}<br>
                    ${addr.address}<br>
                    ${addr.city}, ${addr.state} ${addr.zip}
                `;
            }
        }

        // Update limitations
        function updateLimitations(limitations) {
            // Waiting periods
            if (limitations.waitingPeriods && limitations.waitingPeriods.length > 0) {
                const periods = limitations.waitingPeriods.map(p =>
                    `${p.treatments.join(', ')}: ${p.months} months`
                ).join('<br>');
                document.getElementById('waitingPeriods').innerHTML = periods;
            } else {
                document.getElementById('waitingPeriods').textContent = 'None';
            }

            // Missing tooth clause
            if (limitations.missingToothClause) {
                document.getElementById('missingTooth').textContent =
                    limitations.missingToothClause;
            } else {
                document.getElementById('missingTooth').textContent = 'Not applicable';
            }

            // Orthodontics
            if (limitations.orthodontics && (limitations.orthodontics.ageLimit || limitations.orthodontics.lifetimeMax)) {
                const ortho = limitations.orthodontics;
                document.getElementById('orthodonticsLimitation').style.display = 'block';

                let orthoText = [];
                if (ortho.ageLimit && ortho.ageLimit !== 0) {
                    orthoText.push(`Age Limit: ${ortho.ageLimit === 999 ? 'No limit' : ortho.ageLimit}`);
                }
                if (ortho.lifetimeMax) {
                    orthoText.push(`Lifetime Max: $${ortho.lifetimeMax}`);
                }
                if (ortho.percentage) {
                    orthoText.push(`Coverage: ${ortho.percentage}%`);
                }
                if (ortho.paymentSchedule) {
                    orthoText.push(`Payment: ${ortho.paymentSchedule.substring(0, 50)}...`);
                }

                document.getElementById('orthodonticsDetails').innerHTML = orthoText.join('<br>');
            }
        }

        // Update procedures
        function updateProcedures(procedures, options = {}) {
            const { updateSource = false } = options;
            if (updateSource) {
                allProcedures = procedures || [];
            }

            const list = procedures || visibleProcedures || allProcedures || [];
            visibleProcedures = list;
            const tbody = document.getElementById('proceduresTableBody');
            tbody.innerHTML = '';

            list.forEach(proc => {
                const row = document.createElement('tr');

                if (displaySettings.favorites.includes(proc.code)) {
                    row.classList.add('favorite-procedure');
                }

                // Get coverage percentages
                const inNetwork = proc.coverage['In-Network'] || {};
                const outNetwork = proc.coverage['Out-of-Network'] || {};

                // Category badge class
                const categoryClass = getCategoryClass(proc.cdtCategory);

                // Coverage badge class
                const inClass = getCoverageClass(inNetwork.percentage);
                const outClass = getCoverageClass(outNetwork.percentage);

                const frequencyText = proc.frequency || 'No limitations';
                const sharingText = proc.frequencySharing && proc.frequencySharing.length > 0 ?
                    `Shares with: ${proc.frequencySharing.join(', ')}` : '';
                let ageLimitText = '';
                if (proc.ageLimit) {
                    if (typeof proc.ageLimit === 'object') {
                        const min = proc.ageLimit.min ?? 0;
                        const max = proc.ageLimit.max ?? proc.ageLimit;
                        ageLimitText = proc.ageLimit.max ? `Age: ${min}-${proc.ageLimit.max}` : `Age limit: ${max}`;
                    } else {
                        ageLimitText = `Age limit: ${proc.ageLimit}`;
                    }
                }

                row.innerHTML = `
                    <td class="col-code"><span class="procedure-code">${proc.code}</span></td>
                    <td class="col-description">
                        ${proc.description}
                        ${proc.deductibleApplies ? '<span class="deductible-tag">DED</span>' : ''}
                    </td>
                    <td class="col-category">
                        <span class="category-badge ${categoryClass}">${proc.cdtCategory}</span>
                    </td>
                    <td class="col-planclass">
                        <span class="plan-class-badge">${proc.planClass || '-'}</span>
                    </td>
                    <td class="col-innetwork">
                        <span class="coverage-badge ${inClass}">${inNetwork.percentage || 'N/A'}%</span>
                    </td>
                    <td class="col-outnetwork">
                        <span class="coverage-badge ${outClass}">${outNetwork.percentage || 'N/A'}%</span>
                    </td>
                    <td class="col-frequency">
                        <div class="frequency-text">
                            <span class="frequency-main">${frequencyText}</span>
                            ${sharingText ? `<span class="frequency-sharing">${sharingText}</span>` : ''}
                            ${ageLimitText ? `<span class="frequency-age">${ageLimitText}</span>` : ''}
                        </div>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        // Update history
        function updateHistory(history) {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';

            if (!history || history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">No history available</td></tr>';
                return;
            }

            history.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="procedure-code">${item.code}</span></td>
                    <td>${item.description}</td>
                    <td>${item.firstServiceDate || '-'}</td>
                    <td>${item.lastServiceDate || '-'}</td>
                    <td>${item.count || 0}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update claims
        function updateClaims(claims) {
            const container = document.getElementById('claimsContent');
            container.innerHTML = '';

            if (!claims || claims.length === 0) {
                container.innerHTML = '<p>No claims history available</p>';
                return;
            }

            claims.forEach(claim => {
                const statusClass = getStatusClass(claim.status);
                const claimDiv = document.createElement('div');
                claimDiv.className = 'claim-item';
                claimDiv.innerHTML = `
                    <div class="claim-header">
                        <span class="claim-id">Claim #${claim.claimId}</span>
                        <span class="claim-status ${statusClass}">${claim.statusDescription || claim.status}</span>
                    </div>
                    <div class="claim-details">
                        <div>
                            <strong>Service Date:</strong><br>
                            ${claim.serviceStartDate || '-'}
                        </div>
                        <div>
                            <strong>Provider:</strong><br>
                            ${claim.provider || 'Unknown'}
                        </div>
                        <div>
                            <strong>Amount:</strong><br>
                            Charged: $${claim.totalCharged || 0}<br>
                            Paid: $${claim.deltaPaid || 0}
                        </div>
                    </div>
                `;
                container.appendChild(claimDiv);
            });
        }

        // Helper functions
        function getCategoryClass(category) {
            const map = {
                'Diagnostic': 'diagnostic',
                'Preventive': 'preventive',
                'Restorative': 'restorative',
                'Endodontics': 'endodontics',
                'Periodontics': 'periodontics',
                'Prosthodontics': 'prosthodontics',
                'Prosthodontics (Removable)': 'prosthodontics',
                'Oral Surgery': 'oral-surgery',
                'Implant Services & Oral Surgery': 'oral-surgery',
                'Orthodontics': 'orthodontics'
            };
            return map[category] || 'other';
        }

        function getCoverageClass(percentage) {
            const pct = parseFloat(percentage) || 0;
            if (pct >= 80) return 'high';
            if (pct >= 50) return 'medium';
            return 'low';
        }

        function getStatusClass(status) {
            if (status === 'PD' || status === 'Paid') return 'paid';
            if (status === 'DN' || status === 'Denied') return 'denied';
            return 'pending';
        }

        // Chat assistant (placeholder experience)
        function setupChat() {
            const launcher = document.getElementById('chatLauncher');
            const panel = document.getElementById('chatPanel');
            const closeButton = document.getElementById('chatCloseButton');
            const form = document.getElementById('chatForm');
            const input = document.getElementById('chatInput');

            if (!launcher || !panel || !closeButton || !form || !input) {
                return;
            }

            launcher.addEventListener('click', () => toggleChatPanel());
            closeButton.addEventListener('click', () => toggleChatPanel(false));

            launcher.addEventListener('keydown', event => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    toggleChatPanel();
                }
            });

            form.addEventListener('submit', event => {
                event.preventDefault();
                submitChatMessage();
            });

            document.addEventListener('keydown', event => {
                if (event.key === 'Escape' && chatPanelIsOpen) {
                    toggleChatPanel(false);
                }
            });
        }

        function toggleChatPanel(forceState) {
            const panel = document.getElementById('chatPanel');
            const launcher = document.getElementById('chatLauncher');
            const input = document.getElementById('chatInput');

            if (!panel || !launcher || !input) return;

            const shouldOpen = typeof forceState === 'boolean'
                ? forceState
                : !panel.classList.contains('active');

            chatPanelIsOpen = shouldOpen;
            panel.classList.toggle('active', shouldOpen);
            launcher.setAttribute('aria-expanded', shouldOpen ? 'true' : 'false');

            if (shouldOpen) {
                maybeShowChatWelcome();
                window.requestAnimationFrame(() => input.focus());
            } else {
                if (document.activeElement === input) {
                    launcher.focus();
                }
            }
        }

        function maybeShowChatWelcome() {
            if (chatHasShownWelcome) return;
            chatHasShownWelcome = true;
            appendChatMessage('assistant', "Hi there! I'm ready to help you check coverage, limits, or claims details.");
        }

        function submitChatMessage() {
            const input = document.getElementById('chatInput');
            if (!input) return;

            const message = input.value.trim();
            if (!message) return;

            appendChatMessage('user', message);
            input.value = '';
            simulateChatResponse();
        }

        function appendChatMessage(role, text) {
            const container = document.getElementById('chatMessages');
            if (!container) return;

            const message = document.createElement('div');
            message.className = `chat-message ${role === 'user' ? 'from-user' : 'from-assistant'}`;

            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble';
            bubble.textContent = text;
            message.appendChild(bubble);

            const timestamp = document.createElement('div');
            timestamp.className = 'chat-meta';
            const now = new Date();
            timestamp.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            message.appendChild(timestamp);

            container.appendChild(message);
            container.scrollTop = container.scrollHeight;
        }

        function simulateChatResponse() {
            const container = document.getElementById('chatMessages');
            if (!container) return;

            if (chatResponseTimeout) {
                window.clearTimeout(chatResponseTimeout);
            }

            const existingIndicator = document.getElementById('chatTypingIndicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }

            const typingMessage = document.createElement('div');
            typingMessage.className = 'chat-message from-assistant';
            typingMessage.id = 'chatTypingIndicator';

            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble';
            bubble.innerHTML = '<span class="chat-typing"><span></span><span></span><span></span></span>';
            typingMessage.appendChild(bubble);

            container.appendChild(typingMessage);
            container.scrollTop = container.scrollHeight;

            chatResponseTimeout = window.setTimeout(() => {
                const indicator = document.getElementById('chatTypingIndicator');
                if (indicator) {
                    indicator.remove();
                }

                appendChatMessage('assistant', "Thanks for reaching out! I've noted your request and will surface the most relevant plan details shortly.");
            }, 1200);
        }

        // Filter procedures
        function filterProcedures() {
            const categoryFilter = document.getElementById('categoryFilter').value;
            const classFilter = document.getElementById('classFilter').value;
            const searchFilter = document.getElementById('procedureSearch').value.toLowerCase();

            let filtered = allProcedures.filter(proc => {
                if (categoryFilter && proc.cdtCategory !== categoryFilter) return false;
                if (classFilter && proc.planClass !== classFilter) return false;
                if (searchFilter) {
                    const searchIn = `${proc.code} ${proc.description}`.toLowerCase();
                    if (!searchIn.includes(searchFilter)) return false;
                }
                return true;
            });

            const hasFavorites = Array.isArray(displaySettings.favorites) && displaySettings.favorites.length > 0;

            if (displaySettings.showOnlyFavorites && hasFavorites) {
                filtered = filtered.filter(proc => displaySettings.favorites.includes(proc.code));
            } else if (hasFavorites) {
                filtered = filtered.slice().sort((a, b) => {
                    const aFav = displaySettings.favorites.includes(a.code);
                    const bFav = displaySettings.favorites.includes(b.code);
                    if (aFav === bFav) return 0;
                    return aFav ? -1 : 1;
                });
            }

            if (displaySettings.topCount !== 'all') {
                const limit = parseInt(displaySettings.topCount, 10);
                if (!Number.isNaN(limit) && limit > 0) {
                    filtered = filtered.slice(0, limit);
                }
            }

            updateProcedures(filtered, { updateSource: false });
        }

        // Switch tabs
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // Export to PDF (placeholder)
        function exportPDF() {
            alert('PDF export feature coming soon!');
        }

        // Show COB details
        function showCobDetails() {
            if (window.cobDetails) {
                alert(window.cobDetails);
            }
        }
    </script>
</body>
</html>
